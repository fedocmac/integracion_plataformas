<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Confirmar cuenta</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:2rem;background:#f9f9f9}
    form{max-width:420px;margin:auto;background:#fff;padding:2rem;border-radius:10px;
         box-shadow:0 0 10px rgba(0,0,0,.1)}
    input,button{width:100%;margin:.5rem 0;padding:.7rem;border:1px solid #ccc;border-radius:5px}
    button{background:#007bff;color:#fff;font-weight:bold;cursor:pointer}
    button:hover{background:#0056b3}
    #msg{text-align:center;margin-top:1rem;font-weight:bold}
    .nav{text-align:center;margin-top:1rem}
    .nav a{margin:0 .5rem;color:#007bff;text-decoration:none}
  </style>
</head>
<body>

<h2 style="text-align:center">Confirmar Cuenta</h2>

<form id="conf-form">
  <input name="username" placeholder="Usuario" required>
  <input name="code"     placeholder="Código de verificación" required>
  <button type="submit">Confirmar</button>
</form>

<div id="msg"></div>

<div class="nav">
  <a href="/login/">Login</a> |
  <a href="/registrar/">Registro</a>
</div>

<script>
/* Autocompleta con el usuario recién registrado (si existe) */
document.addEventListener("DOMContentLoaded", () => {
  const stored = localStorage.getItem("pending_user");
  if (stored) document.querySelector('[name="username"]').value = stored;
});

/* Manejo del formulario */
document.getElementById("conf-form").addEventListener("submit", async e => {
  e.preventDefault();
  const f = e.target, m = document.getElementById("msg");
  const payload = {
    username: f.username.value.trim(),
    code    : f.code.value.trim()
  };
  m.textContent = "Confirmando…";

  try {
    const r = await fetch("/api/confirm/", {
      method : "POST",
      headers: { "Content-Type": "application/json" },
      body   : JSON.stringify(payload)
    });
    const res = await r.json().catch(() => ({}));

    if (r.ok) {
      m.textContent = "✅ Usuario confirmado. Redirigiendo al login…";
      setTimeout(() => location.href = "/login/", 2000);
    } else if (r.status === 400) {
      m.textContent = "❌ Usuario o código incorrecto.";
    } else {
      m.textContent = res.message || "❌ Error inesperado.";
    }
  } catch {
    m.textContent = "❌ No se pudo conectar con el servidor. Puede estar caído.";
  }
});
</script>

</body>
</html>
